# Hardened Centos 6 Kickstart File
# Mandatory changes: search for CHANGEME
# For passwords, look at `grub-crypt --sha-512`, which can be used anywhere.

#version=DEVEL
install
cdrom
reboot
lang en_US.UTF-8
keyboard us
xconfig --startxonboot
network --onboot yes --device eth0 --bootproto dhcp --noipv6 --hostname=CHANGEME
rootpw --iscrypted CHANGEME
firewall --enabled --port=22:tcp
authconfig --enableshadow --passalgo=sha512
#user	--name=admin --groups=wheel --iscrypted --password=CHANGEME
selinux --enforcing
timezone --utc America/Los_Angeles
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb quiet fips=1 audit=1 boot=/dev/sda1" --password=CHANGEME

zerombr
part /boot  --size=250     --fstype=ext3
part swap   --recommended
part pv.01  --size=100     --grow

volgroup vg_root --pesize=4096 pv.01
logvol /              --fstype=ext4 --name=root           --vgname=vg_root --size=4096
logvol /home          --fstype=ext4 --name=home           --vgname=vg_root --size=4096
logvol /opt           --fstype=ext4 --name=opt            --vgname=vg_root --size=4096
logvol /tmp           --fstype=ext4 --name=tmp            --vgname=vg_root --size=8192
logvol /usr           --fstype=ext4 --name=usr            --vgname=vg_root --size=8192
logvol /var           --fstype=ext4 --name=var            --vgname=vg_root --size=8192
logvol /var/log       --fstype=ext4 --name=var_log        --vgname=vg_root --size=8192
logvol /var/log/audit --fstype=ext4 --name=var_log_audit  --vgname=vg_root --size=8192

repo --name="base"        --mirrorlist=http://mirrorlist.centos.org/?release=5&arch=x86_64&repo=os
repo --name="updates"     --mirrorlist=http://mirrorlist.centos.org/?release=5&arch=x86_64&repo=updates
repo --name="extras"      --mirrorlist=http://mirrorlist.centos.org/?release=5&arch=x86_64&repo=extras
repo --name="centosplus"  --mirrorlist=http://mirrorlist.centos.org/?release=5&arch=x86_64&repo=centosplus


%packages --ignoremissing
@admin-tools
@base
@base-x
@basic-desktop
@console-internet
@core
@debugging
@desktop-debugging
@desktop-platform
@directory-client
@editors
@fonts
@games
@gnome-desktop
@graphical-internet
@input-methods
@internet-browser
@java
@java-platform
@legacy-x
@network-file-system-client
@print-client
@printing
@remote-desktop-clients
@security-tools
@server-platform
@server-policy
@system-tools
@text-internet
@workstation-policy
@x11
audit
device-mapper-multipath
emacs
fipscheck
gcc-java
iscsi-initiator-utils
java-1.7.0-openjdk
kexec-tools
openscap
openscap-engine-sce
openscap-utils
sendmail-cf
sgpio
system-config-netboot
system-config-netboot-cmd
xorg-x11-utils
xorg-x11-server-Xnest
-abrt-cli
-abrt-gui
-avahi
-b43-fwcutter
-bridge-utils
-microcode_ctl
-nc
-pcmciautils
-pinfo
-rdate
-rfkill
-samba-client
-samba-common
-samba-winbind
-samba-winbind-clients
-samba4-common
-samba4-libs

%pre

# `zerombr` is not always effective. This forces a wipe of the MBR and
# partition table.
dd if=/dev/zero of=/dev/sda bs=4096 count=4096


%post --log=/root/ks-post.log
set -x

###
### License
###

# This entire kickstart file is Copyright CC BY-SA 4.0, 2015, David Barr
# http://creativecommons.org/licenses/by-sa/4.0/
# The canonical version of this file is at
# http://github.com/dafydd2277/systemAdmin/
# The file modifications portions of several Aqueduct scripts have been
# included here. They are Copyright (C) 2013  Vincent C. Passaro
# (vince@buddhalabs.com) under GPL2 or any later version. See
# https://fedorahosted.org/aqueduct/wiki


###
### Environment
###

# NTP Server IP address
s_ntp_server=CHANGEME

# STIG SCAP files destination directory.
d_stig=/root/stig

# STIG and STIG viewer names
s_stig="U_RedHat_5_V1R12_STIG_SCAP_1-1_Benchmark"
s_stig_viewer="stig_viewer_1.2.0"

# STIG and STIG viewer sources.
s_stig_source="http://CHANGEME/${s_stig}.zip"
s_stig_viewer_source="http://CHANGEME/${s_stig_viewer}.jar"


###
### Turn off avahi-daemon
###

ls -al /etc/init.d/avahi*
chkconfig avahi-daemon off
chkconfig avahi-dnsconfd off
/etc/init.d/avahi-daemon stop
/etc/init.d/avahi-dnsconfd stop


###
### /etc/inittab
###

df_file=/etc/inittab
s_user=root
s_group=root
s_perms=644

cp -p -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-37350r1_rule
# The system must require authentication upon booting into single-user and
# maintenance modes.
s_swap="/^si::.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule 37350r1_rule\" RS"
s_swap="${s_swap} \"~:S:wait:/sbin/sulogin\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37327r1_rule
# The x86 CTRL-ALT-DELETE key sequence must be disabled.
s_swap="/^ca::ctrlaltdel.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule 50475r1_rule\" RS"
s_swap="${s_swap} \"#\" \$0 RS"
s_swap="${s_swap} \"ca::ctrlaltdel:/usr/bin/logger -p user.info 'Ctrl-Alt-Delete was pressed'\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### Rules for /etc/issue
###

# DISA STIG Rule SV-37169r1_rule
# The Department of Defense (DoD) login banner must be displayed immediately
# prior to, or as part of, console login prompts.
cat <<"EOISSUE" >/etc/issue
Statement per DISA STIG Rule SV-37169r1_rule:
I've read & consent to terms in the IS user agreem't.
EOISSUE


###
### Rules affecting PAM
###

df_file=/etc/pam.d/system-auth-local
s_user=root
s_group=root
s_perms=644

cat <<"EOSALOCAL" >${df_file}
auth		required	pam_access.so
# DISA STIG Rule SV-37203r1_rule
# The system must disable accounts after three consecutive unsuccessful login
# attempts.
auth		required	pam_tally2.so deny=3
auth		include		system-auth-ac

account		required	pam_tally2.so
account		include		system-auth-ac

# DISA STIG Rule SV-37323r2_rule
# The system must prohibit the reuse of passwords within five iterations.
password	sufficient	pam_unix.so remember=5
# DISA STIG Rule SV-41826r1_rule
# The system must require passwords contain at least one uppercase alphabetic
# character.
# DISA STIG Rule SV-37281r1_rule
# The system must require passwords contain at least one numeric character.
# DISA STIG Rule SV-37287r1_rule
# The system must require passwords contain at least one special character.
# DISA STIG Rule SV-26321r1_rule
# The system must require passwords contain at least one lowercase alphabetic
# character.
# DISA STIG Rule SV-37304r1_rule
# The system must require at least four characters be changed between the old
# and new passwords during a password change.
# DISA STIG Rule SV-37294r1_rule
# The system must require passwords contain no more than three consecutive
# repeating characters.
password	required	pam_cracklib.so ucredit=-1 dcredit=-1 ocredit=-1 lcredit=-1 difok=4 maxrepeat=3
password	include		system-auth-ac

session		include		system-auth-ac

EOSALOCAL

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

rm -f /etc/pam.d/system-auth
ln -s /etc/pam.d/system-auth-local /etc/pam.d/system-auth

df_file=/etc/pam.d/system-auth-ac

# DISA STIG Rule SV-37259r1_rule
# The system must not have accounts configured with blank or null passwords.
sed --in-place=.orig "s/nullok //g" ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

# DISA STIG Rule SV-37389_rule
# The .rhosts file must not be supported in PAM.
pushd /etc/pam.d
for df_file in $(ls -1)
do
  grep -q "pam_rhosts_auth" ${df_file}
  if [ $? -eq 0 ]
  then
    sed --in-place "/.*pam_rhosts_auth.*/ d" ${df_file}
  fi
done
popd


# DISA STIG Rule SV-37345r1_rule
# The system must restrict the ability to switch to the root user to members
# of a defined group.

df_file=/etc/pam.d/su
s_user=root
s_group=root
s_perms=0644

cp -p ${df_file} ${df_file}.orig

s_swap="/^#auth.*required.*pam_wheel.so/"
s_swap="${s_swap}{print \"# DISA STIG Rule 37345r1_rule\" RS"
s_swap="${s_swap} \$0 RS"
s_swap="${s_swap} \"auth\trequired\tpam_wheel.so use_uid\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### Rules affecting /root
###

# DISA STIG Rule SV-37355r1_rule
# The root account's home directory (other than /) must have mode 0700.
chmod 0700 /root


###
### Rules affecting /etc/securetty
###

df_file=/etc/securetty
s_user=root
s_group=root
s_perms=600

cp -p ${df_file} ${df_file}.orig

cat <<"EOSECURETTY" >/etc/securetty
# DISA STIG Rule SV-37374r1_rule
# The system must prevent the root account from logging in from virtual
# consoles.
console

EOSECURETTY

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### Rules affecting system logs.
###

# DISA STIG Rule SV-37228r3_rule
# System log files must have mode 0640 or less permissive.
# (Find command courtesy of http://fedorahosted.org/aqueduct/)
LOGFILES=`find /var/log/ -type f | grep -v wtmp`

for LOGFILETOFIX in $LOGFILES
do
  FILEPERMS=`stat -L --format='%04a' $LOGFILETOFIX`

  FILESPECIAL=${FILEPERMS:0:1}
  FILEOWNER=${FILEPERMS:1:1}
  FILEGROUP=${FILEPERMS:2:1}
  FILEOTHER=${FILEPERMS:3:1}

  if [ $(($FILESPECIAL&7)) != "0" ] || [ $(($FILEOWNER&1)) != "0" ] || [ $(($FILEGROUP&3)) != "0" ] || [ $(($FILEOTHER&7)) != "0" ]
  then
    chmod u-xs,g-wxs,o-rwxt $LOGFILETOFIX
  fi
done


###
### All command files 0755 permissions or less.
###

# DISA STIG Rule SV-37205r2_rule
# All system command files must have mode 0755 or less permissive.
# (Find command courtesy of http://fedorahosted.org/aqueduct/)
for CHKDIR in /etc /bin /usr/bin /usr/lbin /usr/usb /sbin /usr/sbin
do

  if [ -d "$CHKDIR" ]
  then
    for FILENAME in `find $CHKDIR ! -type l`
    do
      if [ -e "$FILENAME" ]
      then
        FILEPERMS=`stat -L --format='%04a' $FILENAME`

        FILESPECIAL=${FILEPERMS:0:1}
        FILEOWNER=${FILEPERMS:1:1}
        FILEGROUP=${FILEPERMS:2:1}
        FILEOTHER=${FILEPERMS:3:1}

        if [ $(($FILEOWNER&0)) != "0" ] || [ $(($FILEGROUP&2)) != "0" ] || [ $(($FILEOTHER&2)) != "0" ]
        then
          #chmod u-s,g-ws,o-wt $FILENAME
          chmod g-w,o-w $FILENAME
        fi
      fi
    done
  fi
done



###
### /etc/profile
### /etc/csh.cshrc
### /etc/bashrc
###

s_user=root
s_group=root
s_perms=644

# DISASTIG Rule SV-37898r2_rule
# The system and user default umask must be 077.
# DISA STIG Rule 37289r1_rule
# Global initialization files must contain the "mesg -n" or "mesg n" commands.
for INITFILE in /etc/bashrc /etc/csh.cshrc /etc/csh.login /etc/profile /etc/profile.d/* `find $(awk -F':' '{if($7 ~ /.*sh/)print $6}' /etc/passwd) -maxdepth 1 -type f`
do
  grep ^[^#]*umask $INITFILE > /dev/null
  if [ $? -eq 0 ]
  then
    grep ^[^#]*umask.*077 $INITFILE > /dev/null
    if [ $? -ne 0 ]
    then
      sed -i "/^[^#]*umask/ c\umask 077" $INITFILE
    fi
  fi
 
cat <<"EOMESGN" >>${INITFILE}

# DISA STIG Rule 37289r1_rule
# Global initialization files must contain the "mesg -n" or "mesg n" commands.
mesg n
EOMESGN

  chown ${s_user}:${s_group} ${df_file}
  chmod ${s_perms} ${df_file}
done


###
### Rules affecting /etc/audit/auditd.conf
###

df_file=/etc/audit/auditd.conf
s_user=root
s_group=root
s_perms=640

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-68095r2_rule
# The audit system must alert designated staff members when the audit storage
# volume approaches capacity.
s_swap="/^disk_full_action.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule SV-68095r2_rule\" RS"
s_swap="${s_swap} \"#\"\$0 RS"
s_swap="${s_swap} \"disk_full_action = single\""
s_swap="${s_swap}; next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

s_swap="/^disk_error_action.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule SV-68095r2_rule\" RS"
s_swap="${s_swap} \"#\"\$0 RS"
s_swap="${s_swap} \"disk_error_action = single\""
s_swap="${s_swap}; next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### Rules affecting /etc/audit/audit.rules
###

df_file=/etc/audit/audit.rules
s_user=root
s_group=root
s_perms=640

cp -p ${df_file} ${df_file}.orig

# (The double backslashes will become nicely formatted single backslashes in
# the file.)

cat <<"EOAUDITRULES" >>${df_file}

# DISA STIG Rule SV-38645r1_rule
# The audit system must be configured to audit failed attempts to access files
# and programs.
# DISA STIG Rule SV-37612r2_rule
# The audit system must be configured to audit failed attempts to access files
# and programs.
# DISA STIG Rule SV-37614r2_rule
# The audit system must be configured to audit failed attempts to access files
# and programs.
# DISA STIG Rule SV-37654r2_rule
# The audit system must be configured to audit failed attempts to access files
# and programs.
# DISA STIG Rule SV-37655r2_rule
# The audit system must be configured to audit failed attempts to access files
# and programs.
-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -k access
-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -k access
-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -k access
-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -k access

# DISA STIG Rule SV-42185r2_rule
# The audit system must be configured to audit files and programs deleted by
# the user.
-a always,exit -F arch=b32 -S rmdir -S unlink -S unlinkat -S rename -S renameat -k delete
-a always,exit -F arch=b64 -S rmdir -S unlink -S unlinkat -S rename -S renameat -k delete

# DISA STIG Rule SV-37944r1_rule
# The audit system must be configured to audit login, logout, and session
# initiation.
-w /var/log/faillog -p wa -k login
-w /var/log/lastlog -p wa -k login

# DISA STIG Rule SV-48488r1_rule
# DISA STIG Rule SV-37668r1_rule
# DISA STIG Rule SV-37669r1_rule
# DISA STIG Rule SV-37673r1_rule
# The audit system must be configured to audit all discretionary access
# control permission modifications.
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -S chown -S chown32 -S fchown -S fchown32 -S fchownat -S lchown -S lchown32 -S fremovexattr -S fsetxattr -S lremovexattr -S lsetxattr -S removexattr -S setxattr -k perm_mod
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -S chown -S fchown -S fchownat -S lchown -S fremovexattr -S fsetxattr -S lremovexattr -S lsetxattr -S removexattr -S setxattr -k perm_mod

# DISA STIG Rule SV-37660r3_rule
# The audit system must be configured to audit all administrative, privileged,
# and security actions.
# DISA STIG Rule SV-50328r3_rule
# The audit system must be configured to audit all attempts to alter system
# time through clock_settime.
# DISA STIG Rule SV-50436r3_rule
# The audit system must be configured to audit all attempts to alter system
# time through adjtimex.
-a always,exit -F arch=b32 -S settimeofday -S clock_settime -S adjtimex -k audit_time_rules
-a always,exit -F arch=b64 -S settimeofday -S clock_settime -S adjtimex -k audit_time_rules

# DISA STIG Rule SV-50331r1_rule
# The audit system must be configured to audit all attempts to alter system
# time through /etc/localtime.
-w /etc/localtime -p wa -k audit_time_rules

# DISA STIG Rule SV-26519r1_rule
# The audit system must be configured to audit account creation.
# DISA STIG Rule SV-26520r1_rule
# The audit system must be configured to audit account modification.
# DISA STIG Rule SV-26521r1_rule
# The audit system must be configured to audit account termination.
-w /usr/sbin/passwd -p x -k audit_account_changes
-w /usr/sbin/useradd -p x -k audit_account_changes
-w /usr/sbin/userdel -p x -k audit_account_changes
-w /usr/sbin/groupadd -p x -k audit_account_changes
-w /usr/sbin/groupdel -p x -k audit_account_changes
-w /etc/passwd -p wa -k audit_account_changes
-w /etc/shadow -p wa -k audit_account_changes
-w /etc/group -p wa -k audit_account_changes
-w /etc/gshadow -p wa -k audit_account_changes
-w /etc/security/opasswd -p wa -k audit_account_changes

# DISA STIG Rule SV-50342r1_rule
# The audit system must be configured to audit modifications to the systems
# Mandatory Access Control (MAC) configuration (SELinux).
-w /etc/selinux/ -p wa -k MAC-policy

# DISA STIG Rule SV-50369r3_rule
# The audit system must be configured to audit successful file system mounts.
-a always,exit -F arch=b32 -S mount -k export
-a always,exit -F arch=b64 -S mount -k export

# DISA STIG Rule SV-50379r1_rule
# The audit system must be configured to audit changes to the /etc/sudoers
# file.
-w /etc/sudoers -p wa -k actions

# DISA STIG Rule SV-50381r2_rule
# The audit system must be configured to audit the loading and unloading of
# dynamic kernel modules.
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b32 -S init_module -S delete_module -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules

# DISA STIG Rule SV-48474r1_rule
# The audit system must be configured to audit all administrative, privileged,
# and security actions.
-w /etc/audit/audit.rules -k audit_rules

# DISA STIG Rule SV-37662r1_rule
# The audit system must be configured to audit all administrative, privileged,
# and security actions.
# DISA STIG Rule SV-37663r1_rule
# The audit system must be configured to audit all administrative, privileged,
# and security actions.
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k host_fqdn

# DISA STIG Rule SV-37664r1_rule
# The audit system must be configured to audit all administrative, privileged,
# and security actions.
# DISA STIG Rule SV-37665r1_rule
# The audit system must be configured to audit all administrative, privileged,
# and security actions.
-a always,exit -F arch=b32 -S sched_setparam -S set_setscheduler -k scheduler

EOAUDITRULES

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

# DISA STIG Rule SV-26510r1_rule
# System audit tool executables must have mode 0750 or less permissive.
# (Find command courtesy of http://fedorahosted.org/aqueduct/)
find /sbin/auditctl /sbin/auditd /sbin/ausearch /sbin/aureport /sbin/autrace /sbin/audispd -perm /7027 -exec chmod u-s,g-ws,o-rwxt {} \;

chkconfig auditd on
service auditd start


###
### xinetd
###

# DISA STIG Rule SV-37408r2_rule
# The xinetd configuration files must have mode 0640 or less permissive.
chmod 0640 /etc/xinetd.conf /etc/xinetd.d/*

# DISA STIG Rule SV-37555r1_rule
# All FTP users must have a default umask of 077.

df_file=/etc/xinetd.d/gssftp
s_user=root
s_group=root
s_perms=0640

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-37555r1_rule
# The system must not permit root logins using remote access programs such as
# ssh.
s_swap="/.*server_args.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule SV-37555r1_rule\" RS"
s_swap="${s_swap} \"# \" \$0 RS"
s_swap="${s_swap} \$0 \" -u 077\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### Control script permissions.
###

# DISA STIG Rule SV-37192r1_rule
# All run control scripts must have mode 0755 or less permissive.
# (Find command courtesy of http://fedorahosted.org/aqueduct/)
find /etc/rc.d/ -type f -perm /7022 -exec chmod u-s,g-ws,o-wt {} \;

###
### Device files
###

# DISA STIG Rule SV-37553r2_rule
# Device files and directories must only be writable by users with a system
# account or as configured by the vendor.
# (Commands courtesy of http://fedorahosted.org/aqueduct/)
WWWFiles=$( find / -fstype nfs -prune -o -perm -2 -a \( -type b -o -type c \) 2>/dev/null | egrep -v '(/dev/full|/dev/random|/dev/zero|/dev/tty|/dev/ptmx|/dev/null|/dev/urandom|/selinux/null|/dev/fuse|/dev/net/tun)' )

for file in $WWWFiles
do
  chmod o-w $file
done


###
### Crontab files
###

# DISA STIG Rule SV-37466r1_rule
# Crontab files must have mode 0600 or less permissive, and files in cron
# script directories must have mode 0700 or less permissive.
chmod 0600 /var/spool/cron/* /etc/cron.d/* /etc/crontab

# DISA STIG Rule SV-37745r1_rule
# Files in cron script directories must have mode 0700 or less permissive.
chmod 0700 /etc/cron.daily/* /etc/cron.hourly/* /etc/cron.monthly/* /etc/cron.weekly/*


###
### Rules affecting atd and cron
###

chkconfig atd off
service atd stop

s_user=root
s_group=root
s_perms=0600

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-37516r1_rule
# The at.deny file must not be empty if it exists.
# DISA STIG Rule SV-27338r1_rule
# Default system accounts (with the exception of root) must not be listed in
# the cron.allow file or must be included in the cron.deny file, if cron.allow
# does not exist.
for df_file in /etc/at.deny /etc/cron.deny
do
cat <<"EODENY" >${df_file}
bin
daemon
adm
lp
sync
mail
news
uucp
operator
games
gopher
ftp
nobody
nscd
vcsa
pcap
ntp
dbus
avahi
rpc
apache
mailnull
smmsp
sshd
xfs
haldaemon
avahi-autoipd
rpcuser
nfsnobody
gdm
sabayon

EODENY

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

done

s_user=root
s_group=root
s_perms=0600

# DISA STIG Rule 37517r1_rule
# Default system accounts (with the exception of root) must not be listed in
# the at.allow file or must be included in the at.deny file if the at.allow
# file does not exist.
for df_file in /etc/at.allow /etc/cron.allow
do
cp -p ${df_file} ${df_file}.orig
cat <<"EOATALLOW" >${df_file}
root

EOATALLOW

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}
done


###
### Modify password settings in the shadow file.
###

# DISA STIG Rule SV-37293r1_rule
# Users must not be able to change passwords more than once every 24 hours.
# DISA STIG Rule SV-37298r1_rule
# User passwords must be changed at least every 60 days.
for s_user in $(cat /etc/shadow | cut -d: -f1)
do
  passwd -n 1 -x 60 ${s_user}
done


###
### /etc/ssh/ssh_config
###

df_file=/etc/ssh/ssh_config

s_user=root
s_group=root
s_perms=640

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-37820r1_rule
# The system must not permit root logins using remote access programs such as
# ssh.
s_swap="/^#.*Protocol.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37820r1_rule\" RS"
s_swap="${s_swap} \"Protocol 2\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37828r1_rule
# The SSH client must be configured to only use FIPS 140-2 approved ciphers.
# DISA STIG Rule SV-37830r1_rule
# The SSH client must be configured to not use Cipher-Block Chaining
# (CBC)-based ciphers.
# DISA STIG Rule SV-37836r1_rule
# The SSH client must be configured to only use Message Authentication Codes
# (MACs) employing FIPS 140-2 approved cryptographic hash algorithms.
s_swap="/^#.*Ciphers.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37828r1_rule\" RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37830r1_rule\" RS"
s_swap="${s_swap} \"Ciphers aes256-ctr,aes192-ctr,aes128-ctr\" RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37836r1_rule\" RS"
s_swap="${s_swap} \"MACS hmac-sha1\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37868r2_rule
# The SSH client must not permit GSSAPI authentication unless needed.
# ssh.
s_swap="/^.*GSSAPIAuthentication.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule SV-37868r2_rule\" RS"
s_swap="${s_swap} \"# \" \$0 RS"
s_swap="${s_swap} \"GSSAPIAuthentication no\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### /etc/ssh/sshd_config
###

df_file=/etc/ssh/sshd_config
s_user=root
s_group=root
s_perms=640

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-37824r3_rule
# The SSH daemon must be configured to only use FIPS 140-2 approved ciphers.
# DISA STIG Rule SV-37826r2_rule
# The SSH daemon must be configured to only use Message Authentication Codes
# (MACs) employing FIPS 140-2 approved cryptographic hash algorithms.
# DISA STIG Rule SV-37843r2_rule
# The SSH daemon must restrict login ability to specific users and/or groups.
cat <<EOSSHDCONFIG >>${df_file}

# DISA STIG Rule SV-37824r3_rule
Ciphers aes256-ctr,aes192-ctr,aes128-ctr
# DISA STIG Rule SV-37826r2_rule
MACS hmac-sha1
# DISA STIG SV-37843r2_rule
AllowGroups *
AllowUsers *

EOSSHDCONFIG


# DISA STIG Rule SV-37156r1_rule
# The system must not permit root logins using remote access programs such as
# ssh.
s_swap="/^#PermitRootLogin.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule SV-37156r1_rule\" RS"
s_swap="${s_swap} \$0 RS"
s_swap="${s_swap} \"PermitRootLogin no\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37866r3_rule
# The SSH daemon must not permit GSSAPI authentication unless needed.
s_swap="/^GSSAPIAuthentication.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule SV-37866r3_rule\" RS"
s_swap="${s_swap} \"GSSAPIAuthentication no\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37872r2_rule
# The SSH daemon must not permit Kerberos authentication unless needed.
s_swap="/^#KerberosAuthentication.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37872r2_rule\" RS"
s_swap="${s_swap} \"KerberosAuthentication no\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37900r2_rule
# The SSH daemon must perform strict mode checking of home directory
# configuration files.
s_swap="/^#StrictModes.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37900r2_rule\" RS"
s_swap="${s_swap} \"StrictModes yes\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37904r2_rule
# The SSH daemon must use privilege separation.
s_swap="/^#UsePrivilegeSeparation.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37904r2_rule\" RS"
s_swap="${s_swap} \"UsePrivilegeSeparation yes\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37905r2_rule
# The SSH daemon must not allow rhosts RSA authentication.
s_swap="/^#RhostsRSAAuthentication no.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37905r2_rule\" RS"
s_swap="${s_swap} \"RhostsRSAAuthentication no\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37908r2_rule
# The SSH daemon must not allow compression or must only allow compression
# after successful authentication.
s_swap="/^#Compression delayed.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37908r2_rule\" RS"
s_swap="${s_swap} \"Compression delayed\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

# DISA STIG Rule SV-37915r3_rule
# The SSH daemon must be configured with the Department of Defense (DoD) logon
# banner.
s_swap="/^#Banner.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37915r3_rule\" RS"
s_swap="${s_swap} \"Banner /etc/issue\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### /etc/security/access.conf
###

# DISA STIG Rule SV-37243r2_rule
# The /etc/security/access.conf file must have mode 0640 or less permissive.

df_file=/etc/security/access.conf
s_user=root
s_group=root
s_perms=0640

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### Graphical Desktop Environment
###

# DISA STIG Rule 48455r1_rule
# The graphical desktop environment must automatically lock after 15 minutes
# of inactivity and the system must require user reauthentication to unlock
# the environment.
gconftool-2 \
  --direct \
  --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory \
  --type bool \
  --set /apps/gnome-screensaver/idle_activation_enabled true

# DISA STIG Rule SV-48550r1_rule
# The graphical desktop environment must set the idle timeout to no more than
# 15 minutes.
gconftool-2 \
  --direct \
  --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory \
  --type int \
  --set /apps/gnome-screensaver/idle_delay 15

# DISA STIG Rule SV-48551r1_rule
# Graphical desktop environments provided by the system must have automatic
# lock enabled.
gconftool-2 \
  --direct \
  --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory \
  --type bool \
  --set /apps/gnome-screensaver/lock_enabled true

# DISA STIG Rule SV-37217r2_rule
# An X server must have none of the following options enabled: -ac, -core
# (except for debugging purposes), or -nolock.
# (Commands from http://fedorahosted.org/aqueduct/ )
if [ -e /etc/gdm/custom.conf ]
then
  XAUDITLEVEL=$( grep -c "command=/usr/bin/Xorg -br -audit 4 -s 15" /etc/gdm/custom.conf )
  if [ $XAUDITLEVEL -eq 0 ]
  then
    cat <<EOF >> /etc/gdm/custom.conf

# DISA STIG Rule SV-37217r2_rule
[server-Standard]
name=Standard server
command=/usr/bin/Xorg -br -audit 4 -s 15
chooser=false
handled=true
flexible=true
priority=0
EOF

  fi # if [ $XAUDITLEVEL -eq 0 ]

else
  # If the file isn't there, lets create it.
  mkdir /etc/gdm 2> /dev/null
  chmod 755 /etc/gdm 2> /dev/null

  cat <<EOF >> /etc/gdm/custom.conf
# DISA STIG Rule SV-37217r2_rule
[server-Standard]
name=Standard server
command=/usr/bin/Xorg -br -audit 4 -s 15
chooser=false
handled=true
flexible=true
priority=0
EOF

fi # if [ -e /etc/gdm/custom.conf ] / else


###
### /etc/security/opasswd
###

# DISA STIG Rule 37323r2_rule
# The system must prohibit the reuse of passwords within five iterations.
# (See also the "password pam_unix.so" line in system-auth-local, above.)
df_file=/etc/security/opasswd
s_user=root
s_group=root
s_perms=0600

touch ${df_file}
chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

###
### news, shutdown and halt
###

# DISA STIG Rule SV-37181r1_rule
# The system must not have special privilege accounts, such as shutdown and
# halt.
# DISA STIG Rule SV-34574r1_rule
# The system must not have the unnecessary "news" account.
# DISA STIG Rule SV-34575r1_rule
# The system must not have the unnecessary "gopher" account.
for s_user in shutdown halt news gopher
do
  userdel ${s_user}
done


###
### Rules affecting /etc/sysctl.conf
###

df_file=/etc/sysctl.conf
s_user=root
s_group=root
s_perms=0600

cp -p ${df_file} ${df_file}.orig

cat <<"EOSYSCTL" >>${df_file}

# DISA STIG Rule SV-37594r1_rule
# TCP backlog queue sizes must be set appropriately.
net.ipv4.tcp_max_syn_backlog=1280

# DISA STIG Rule SV-37616r2_rule
# The system must ignore IPv6 ICMP redirects messages.
net.ipv6.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0

# DISA STIG Rule SV-37626r1_rule
# The system must ignore IPv4 Internet Control Message Protocol (ICMP)
# redirect messages.
net.ipv4.conf.default.accept_redirects=0
net.ipv4.conf.all.accept_redirects = 0

# DISA STIG Rule SV-37629r1_rule
# The system must not send IPv4 Internet Control Message Protocol (ICMP)
# redirects.
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# DISA STIG Rule SV-37630r1_rule
# The system must log Martian packets.
net.ipv4.conf.default.log_martians = 1
net.ipv4.conf.all.log_martians = 1

# DISA STIG Rule SV-29795r1_rule
# The system must not accept IPv4 source-routed packets by default.
net.ipv4.conf.default.accept_source_route = 0

# DISA STIG Rule SV-37633r1_rule
# The system must be configured to use TCP syncookies when experiencing a TCP
# SYN flood.
net.ipv4.tcp_syncookies = 1

# DISA STIG Rule SV-37930r2_rule
# The system must not have IP forwarding for IPv6 enabled, unless the system
# is an IPv6 router.
net.ipv6.conf.all.forwarding = 0

EOSYSCTL

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

## Now that /etc/sysctl.conf is updated, modify the running system.
sysctl -w net.ipv4.tcp_max_syn_backlog=1280
sysctl -w net.ipv4.conf.default.accept_redirects=0
sysctl -w net.ipv4.conf.all.accept_redirects=0
sysctl -w net.ipv4.conf.default.log_martians=1
sysctl -w net.ipv4.conf.all.log_martians=1
sysctl -w net.ipv4.conf.default.accept_source_route=0
sysctl -w net.ipv4.tcp_syncookies=1
sysctl -w net.ipv6.conf.all.forwarding=0
sysctl -w net.ipv6.conf.default.accept_redirects=0
sysctl -w net.ipv6.conf.all.accept_redirects=0
sysctl -w net.ipv4.conf.default.send_redirects=0
sysctl -w net.ipv4.conf.all.send_redirects=0


###
### /bin/traceroute
###

df_file=/bin/traceroute
s_user=root
s_group=root
s_perms=0700

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

###
### Sendmail
###

df_file=/etc/mail/sendmail.mc
s_user=root
s_group=root
s_perms=0644

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-37505r2_rule
# The SMTP service's SMTP greeting must not provide version information.
# DISA STIG Rule SV-37506r2_rule
# The system must not use .forward files.
s_swap="/.*SMTP_LOGIN_MSG.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule SV-37505r2_rule\" RS"
s_swap="${s_swap} \"#\"\$0 RS"
s_swap="${s_swap} \"define(\`confSMTP_LOGIN_MSG\', \`Mail Server Ready; \$b\')dnl\" RS"
s_swap="${s_swap} \"# DISA STIG Rule SV-37506r2_rule\" RS"
s_swap="${s_swap} \"define(\`confFORWARD_PATH\', \`\')dnl\" RS"
s_swap="${s_swap}; next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

/usr/bin/make -C /etc/mail

# DISA STIG Rule SV-37504r4_rule
# The SMTP service HELP command must not be enabled.
echo -n >/etc/mail/helpfile


###
### Global init files
###

# DISA STIG Rule SV-37275r1_rule
# All global initialization files must have mode 0644 or less permissive.
# (Command from http://fedorahosted.org/aqueduct/ )
find /etc/.login /etc/profile /etc/bashrc /etc/environment /etc/security /etc/profile.d /etc/suid_profile /etc/csh.logout /etc/ksh.kshrc -perm /7133 -type f -exec chmod u-xs,g-wxs,o-wxt {} \; 2>/dev/null



###
### Rules affecting NTP.
###

# DISA STIG Rule SV-26292r3_rule
# The system clock must be synchronized continuously, or at least daily.
df_file=/etc/ntp.conf
s_user=root
s_group=root
s_perms=0640

sed --in-place=.orig "/^server.*/s/^/#/" ${df_file}

cat <<EONTPCONF >> /etc/ntp.conf

server ${s_ntp_server}

EONTPCONF

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

ls -al /etc/init.d/ntpd
chkconfig ntpd on
service ntpd start


###
### /etc/hosts.allow and /etc/hosts.deny
###

# DISA STIG Rule SV-37758r1_rule
# The system's access control program must be configured to grant or deny
# system access to specific hosts.
df_file=/etc/hosts.allow
s_user=root
s_group=root
s_perms=0640

cat <<"EOALLOW" >>${df_file}

KNOWN:ALL
EOALLOW

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

df_file=/etc/hosts.deny
s_user=root
s_group=root
s_perms=0640

cat <<"EODENY" >>${df_file}

ALL:ALL
EODENY

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

###
### Rules affecting NFS and autofs.
###

# DISA STIG Rule SV-26662r1_rule
# The portmap or rpcbind service must not be running unless needed.
chkconfig portmap off
service portmap stop

# DISA STIG Rule SV-26666r1_rule
# The portmap or rpcbind service must not be installed unless needed.
yum -y remove portmap

# DISA STIG Rule SV-37980r2_rule
# Automated file system mounting tools must not be enabled unless needed.
ls -al /etc/init.d/autofs
chkconfig autofs off
service autofs stop


###
### /etc/syslog.conf
###

# DISA STIG Rule SV-37709r2_rule
# The /etc/syslog.conf file must have mode 0640 or less permissive.
df_file=/etc/syslog.conf
s_user=root
s_group=root
s_perms=0640

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

# DISA STIG Rule SV-37757r2_rule
# The system's access control program must log each system access attempt.
# (Commands from http://fedorahosted.org/aqueduct/ )
MAILDEBUG=$( cat /etc/syslog.conf |egrep -i '(mail\.\*|mail\.debug)' | grep -v '^#' | wc -l )
MAILNONE=$( cat /etc/syslog.conf |egrep -i '(mail\.\*|mail\.none)' | grep -v '^#' | wc -l )
MAILALL=$( cat /etc/syslog.conf |egrep -i '(mail\.\*|mail\.*)' | grep -v '^#' | wc -l )
AUTHPRIV=$( cat /etc/syslog.conf |egrep -i '(authpriv\.\*|authpriv\.info)' | grep -v '^#' | wc -l )

if [ $MAILDEBUG -eq 0 ]
  then
  echo "# DISA STIG Rule SV-37757r2_rule" >> /etc/syslog.conf
  echo "mail.debug                                                      -/var/log/maillog"  >> /etc/syslog.conf
fi

if [ $MAILNONE -eq 0 ]
  then
  echo "# DISA STIG Rule SV-37757r2_rule" >> /etc/syslog.conf
  echo "mail.none                                                       -/var/log/maillog"  >> /etc/syslog.conf
fi

if [ $MAILALL -eq 0 ]
  then
  echo "# DISA STIG Rule SV-37757r2_rule" >> /etc/syslog.conf
  echo "mail.*                                                  -/var/log/mail"  >> /etc/syslog.conf
fi

if [ $MAILALL -eq 0 ]
  then
  echo "# DISA STIG Rule SV-37757r2_rule" >> /etc/syslog.conf
  echo "authpriv.info                                                   -/var/log/messages"  >> /etc/syslog.conf
fi

# DISA STIG Rule SV-27352r2_rule
# Cron logging must be implemented.
# (Commands from http://fedorahosted.org/aqueduct/ )
GOODCRON=$( grep -ic "^cron" /etc/syslog.conf )

if [ $GOODCRON -lt 1 ]
  then
    echo "cron.*                                                        /var/log/cron" >> /etc/syslog.conf
fi


###
### /etc/ldap.conf
###

df_file=/etc/ldap.conf
s_user=root
s_group=root
s_perms=0644

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-37632r1_rule
# If the system is using LDAP for authentication or account information, the
# LDAP TLS connection must require the server provide a certificate with a
# valid trust path to a trusted CA.
# DISA STIG Rule SV-37634r1_rule
# If the system is using LDAP for authentication or account information, the
# system must verify the LDAP server's certificate has not been revoked.
s_swap="/^#tls_checkpeer.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule SV-37632r1_rule\" RS"
s_swap="${s_swap} \$0 RS"
s_swap="${s_swap} \"tls_checkpeer yes\" RS"
s_swap="${s_swap}; next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

cat <<"EOLDAP" >>${df_file}

# DISA STIG Rule SV-37634r1_rule
tls_crlcheck all

EOLDAP

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### Rules placed in /etc/modprobe.d
###

df_file=/etc/modprobe.d/disa_stig.conf
s_user=root
s_group=root
s_perms=644

cat <<"EOMODPROBE" >${df_file}
# DISA STIG Rule SV-37761r1_rule
# The Stream Control Transmission Protocol (SCTP) must be disabled unless
# required.
install sctp /bin/true

# DISA STIG Rule SV-37763r1_rule
# The Datagram Congestion Control Protocol (DCCP) must be disabled unless
# required.
install dccp /bin/true

# DISA STIG Rule SV-37603r1_rule
# The Reliable Datagram Sockets (RDS) protocol must be disabled or not
# installed unless required.
install rds /bin/true

# DISA STIG Rule SV-37604r1_rule
# The Transparent Inter-Process Communication (TIPC) protocol must be disabled
# or uninstalled.
install tipc /bin/true

# DISA STIG Rule SV-37605r1_rule
# The Bluetooth protocol handler must be disabled or not installed.
install bluetooth /bin/true

# DISA STIG Rule SV-37606r1_rule
# The IPv6 protocol handler must not be bound to the network stack unless
# needed.
alias net-pf-10 off
alias ipv6 off

# DISA STIG Rule SV-37609r1_rule
# The Bluetooth protocol handler must be disabled or not installed.
install ipv6 /bin/true

# DISA STIG Rule SV-37982r1_rule
# The system must have USB Mass Storage disabled unless needed.
install usb-storage /bin/true

# DISA STIG Rule SV-37983r1_rule
# The system must have IEEE 1394 (Firewire) disabled unless needed.
install ieee1394 /bin/true

EOMODPROBE

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### /etc/dhclient.conf
###

df_file=/etc/dhclient.conf
s_user=root
s_group=root
s_perms=0640

# DISA STIG Rule SV-26933r2_rule
# The DHCP client must not send dynamic DNS updates.
cat <<"EODHCLIENT" >/etc/dhclient.conf
do-forward-updates false;

EODHCLIENT

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### /etc/security/limits.conf
###

df_file=/etc/security/limits.conf
s_user=root
s_group=root
s_perms=644

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-50476r2_rule
# Process core dumps must be disabled unless needed.
s_swap="/.*soft.*core.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule 50476r1_rule\" RS"
s_swap="${s_swap} \"*\thard\tcore\t0\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}


# DISA STIG Rule SV-37182r1_rule
# The system must limit users to 10 simultaneous system logins, or a
# site-defined number, in accordance with operational requirements.
s_swap="/.*student.*maxlogins.*/"
s_swap="${s_swap}{print \$0 RS"
s_swap="${s_swap} \"# DISA STIG Rule 37182r1_rule\" RS"
s_swap="${s_swap} \"*\thard\tmaxlogins\t10\""
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


####
#### Network interfaces
####

df_file=/etc/sysconfig/network
s_user=root
s_group=root
s_perms=0644

cp -p ${df_file} ${df_file}.orig

# DISA STIG Rule SV-37606r1_rule
# The IPv6 protocol handler must not be bound to the network stack unless
# needed.
s_swap="/^NETWORKING_IPV6.*/"
s_swap="${s_swap}{print \"# DISA STIG Rule 37606r1_rule\" RS"
s_swap="${s_swap} \"# \" \$0 RS"
s_swap="${s_swap} \"NETWORKING_IPV6=no"
s_swap="${s_swap};next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

## DISA STIG Rule SV-50480r2_rule
## The DHCP client must be disabled if not needed.
#for df_file in $(ls -1 /etc/sysconfig/network-scripts/ifcfg-*)
#do
#  sed --in-place 's/^BOOTPROTO.*/BOOTPROTO=none/g' ${df_file}
#done

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}


###
### /var/crash
###

# DISA STIG Rule SV-26612r1_rule
# The kernel core dump data directory must have mode 0700 or less permissive.
chmod 0700 /var/crash


###
### Test the hardened system.
###

mkdir ${d_stig}
pushd ${d_stig}

/usr/bin/wget ${s_stig_source}
/usr/bin/wget ${s_stig_viewer_source}

# Run the jar with `java -jar ${s_viewer}.jar`, substituting as appropriate.

mkdir -p ${s_stig}
cd ${s_stig}
unzip ../${s_stig}.zip

df_cpe=${s_stig}-cpe-dictionary.xml

sed --in-place=.orig \
  's/<Group\ \(.*\)/<Group\ selected="false"\ \1/g' \
  ${s_stig}-xccdf.xml

sed --in-place=.orig \
"s#<platform>Red Hat Enterprise Linux 5</platform>#<platform>CentOS 5</platform>##g" \
${s_stig}-cpe-oval.xml

sed --in-place \
"s#cpe:/o:redhat:enterprise_linux:5#cpe:/o:centos:centos:5##g" \
${s_stig}-cpe-oval.xml

# The <platform> tag is optional in the XCCDF standard. So, since I can't
# figure out the correct string for CentOS, just comment the line.
df_file=${s_stig}-xccdf.xml
s_user=root
s_group=root
s_perms=644

cp -p ${df_file} ${df_file}.orig

s_swap="/<platform.*redhat:enterprise_linux/"
s_swap="${s_swap}{print \"<!-- \" \$0 \" -->\" RS"
s_swap="${s_swap}; next}1"
awk "${s_swap}" ${df_file} >${df_file}.new && mv ${df_file}.new ${df_file}

chown ${s_user}:${s_group} ${df_file}
chmod ${s_perms} ${df_file}

# Then, resolve the file and scan the host.

oscap xccdf resolve \
  --output ${s_stig}_Resolved-xccdf.xml \
  ${s_stig}-xccdf.xml

oscap xccdf generate guide \
  --profile MAC-1_Classified \
  --output ../RHEL6_Guide.html \
  ${s_stig}_Resolved-xccdf.xml

oscap xccdf eval \
  --profile MAC-1_Classified \
  --check-engine-results \
  --results ../Hard_Install_Results.xml \
  --report ../Hard_Install_Results.html \
  --cpe ${df_cpe} \
  ${s_stig}_Resolved-xccdf.xml \
  >../Hard_Install_STDOUT.txt 2>&1



# vim:set nu tabstop=2 shiftwidth=2 expandtab hlsearch:

